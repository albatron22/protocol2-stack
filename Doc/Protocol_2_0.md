# Протокол взаимодействия уровней системы (верхний, нижний). Описание структуры.

*Данный протокол является развитием протокола взаимодействия верхнего и нижненго уровня подводного аппарата (вспоминай бессоные мартовские ночи 2021 года...).* 

Цель - создать универсальный стек протокола взаимодействия уровней управления внутри одной системы. Обычно различают **верхний (HL)** и **нижний (LL)** уровни системы, между которомы просихордит обмен данными (команды управления, телеметрия и др.). К верхнему уровню может относиться компьютер, встраиваемый микрокомпьютер (одноплатник) или микроконтроллер. К нижнему уровню чаще всего относят микроконтроллер, который отвечает за управление системой на нижнем, аппаратном уровне. Формат данных текстовый (ASCII симоволы). Пользователь сам определяет формат и структуру блока данных, следующих за заголовком. Данные сообщений должны анализироваться в call-back функциях для каждого типа пакета. 

Связь двухсторонняя, асинхронная. Со стороны верхнего уровня (HL) передаются команды управления и запросы (Down Link канал - DL), со стороны нижнего (LL) уровня (Up Link канал - UL), например, показания датчиков (**телеметрия**) или ответы на запросы.

## Общий формат пакетов

Версия протокола 2.0 основана на открытых протоколах Wialon IPS и NMEA.

Пакеты имеют определённую структуру с символами начала `'$'` и конца пакета `\r\n` и полями заголовка пакета и блока данных между ними. В пакете могут передаваться данные разного характера, они определяется **типом пакета** в заголовке. Данные передаются в произвольном формате, которые определяется пользователем. Данные должны быть представлены **символьном** виде (ASCII), представляя собой форматированную строку. Для контроля целостности пакета используется простая контрольная сумма. Она считается для байт пакета между началом `'$'` и концом блока данных `'*'`, непосредственно после которого встраивается в пакет. 

**Струкутура пакета:**

![pkg](pkg.drawio.png)

```
$[TYPE]$[var_1,...,var_n]*<CS><CR><LF>
|  PT  |   DATA BLOCK    | CS |
```

**PT (Package Type)** - заголовок пакета

**DATA BLOCK** - блок полезных данных пакета

**CS (CheckSum)** - контрольная сумма пакета

Ниже приведено детальное описание полей пакета сообщения.

Поле | Описание | Формат | Размер, байт
-----|----------|--|--
`'$'` | Символ начала пакета (`PRTCL2_START_SYMBOL`). По умолчанию импользуется символ `'$'`. *Может быть переопределён на другой символ* | ASCII-символ | 1
`[TYPE]` | Тип пакета (`PRTCL2_PKG_TYPE`) | ASCII-строка | 1..32
`'$'` | Разделитель полей типа пакета и блока данных (`PRTCL2_PT_SYMBOL`). *Также может быть переропределён другим символом (например, в NMEA это символ запятой* | ASCII-символ | 1
`[var_1,...,var_n]`| Блок полезных данных - данные пакета, относящиеся к соответствующему заголовку. В общем случае структура блока данных может быть произвольной. По умолчанию рекомендуется внутри блока данных поля разделять знаком запятой `','`. *Блок данных в некоторых случаях может быть пустой, если заголовк считается командой*. | ASCII-строка | 0..509
`'*'` | Символ окончания блока данных. После него в пакет расположены байты контрольной суммы | ASCII-символ | 1
`<CS>` | Контрольная сумма пакета в символьном виде (байт в шестнадцатеричном представлении) | ASCII-строка | 2
`<CR><LF>`| Символы конца сообщения (символы переноса каректи и строки `\r\n`) | Спец. символы ASCII | 2

*Примеры пакетов с символьным форматом блока данных*
```
$FORCE$10,-20,30*54\r\n
$MOM$30,40,-50*44\r\n
```

**PT**. Заголовок пакета, содержащий тип пакета `[TYPE]` определяет для взаимодействующих уровней формат, структуру и содержание данных.

**DATA BLOCK**. Структура блока данных и содержание данных, а также символ разделителя для символьного формата (рекомендуется символ запятой `,`), определяется пользователем. Обработка, как и генерация блока данных, лежит на пользователе. Обработка данных, соответствущих заголовку, должна происходить в call-back функциях для каждого типа заголовка. Call-back функции вызываются по приему каждого пакета после его анализа встроенным конечным автоматом стека протокола.

**CHECKSUM**. Контрольная сумма пакета ставится в конце блока полезных данных после символа окончания данных `'*'`. Контрольная сумма представляет собой исключающее ИЛИ (XOR) всех байт между символом начала пакета `'$'` и символом окончания блока данных `'*'` (как в протоколе NMEA). Размер контрольной суммы - 1 байт. Байт контрольной суммы добавляется в пакет с переводом его в символьный формат, как это делается в протоколе NMEA. Например, имеем пакет `$FORCE$10,-20,30*54\r\n`, тогда контрольная сумма считается для строки `FORCE$10,-20,30`, которая в данном случае численно равна `0x54`. Затем байт контрольной суммы переводится в строку в шестнадцатеричном представлении, т.е. `"54"`.

