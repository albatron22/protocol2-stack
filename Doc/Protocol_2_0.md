# Протокол взаимодействия уровней системы (верхний, нижний). Описание структуры.

*Данный протокол является развитием протокола взаимодействия верхнего и нижненго уровня подводного аппарата (вспоминай бессоные мартовские ночи 2021 года...).* 

Цель - создать универсальный стек протокола взаимодействия уровней управления внутри одной системы. Обычно различают **верхний (HL)** и **нижний (LL)** уровни системы, между которомы просихордит обмен данными (команды управления, телеметрия и др.). К верхнему уровню может относиться компьютер, встраиваемый микрокомпьютер (одноплатник) или микроконтроллер. К нижнему уровню чаще всего относят микроконтроллер, который отвечает за управление системой на нижнем, аппаратном уровне. Формат данных может быть текстовым (ASCII симоволы) и бинарным. Пользователь сам определяет формат и тип данных, следующих за заголовком. Данные сообщений должны анализироваться в call-back функциях. 

Связь двухсторонняя, асинхронная. Со стороны верхнего уровня (HL) передаются команды управления и запросы (Down Link канал - DL), со стороны нижнего (LL) уровня (Up Link канал - UL), например, показания датчиков (**телеметрия**) или ответы на запросы.

## Общий формат пакетов

Версия протокола 2.0 основана на открытых протоколах Wialon IPS и NMEA.

Пакеты имеют определённую структуру с символами начала `'$'` и конца пакета `\r\n` и полями заголовка пакета и блока данных между ними. В пакете могут передаваться данные разного характера, они определяется **типом пакета** в заголовке. Данные передаются в произвольном формате, которые определяется пользователем. Данные могут быть пресдавлены в **бинарном** или **символьном** виде (ASCII), представляя собой форматированную строку. Контрольная сумма всех байт и символов пакета между началом `'$'` и символом конца блока данных `'*'` ставится в конце блока данных. 

**Струкутура пакета:**

```
$[TYPE]$[var_1,...,var_n]*<CS><CR><LF>
|  PT  |     PAYLOAD    |
$[TYPE]$<..binary data..>*<CS><CR><LF>
```

**PT** - заголовок пакета

**PAYLOAD** - блок полезных данных пакета

Ниже приведено детальное описание полей пакета сообщения.

Поле | Описание | Формат | Размер, байт
-----|----------|--|--
`'$'` | Символ начала пакета (`PRTCL2_START_SYMBOL`). По умолчанию импользуется символ `'$'`. *Может быть переопределён на другой символ* | ASCII-символ | 1
`[TYPE]` | Тип пакета (`PRTCL2_PKG_TYPE`) | ASCII-строка | 1..32
`'$'` | Разделитель полей типа пакета и блока данных (`PRTCL2_PT_SYMBOL`). *Также может быть переропределён другим символом (например, в NMEA это символ запятой* | ASCII-символ | 1
`[var_1,...,var_n]` или <p>`<..binary data..>`</p>| Блока данных, или PAYLOAD - полезная нагрузка, непосредственно данные пакета, относящиеся к соответствующему заголовку. Если формат данных символьный, то рекомендуется внутри данных использовать разделение знаком запятой `','`. Если бинарные, то разделитель не обязателен. *Данные в некоторых случаях могу отсутствовать, если заголовк считается командой*. | ASCII-строка или бинарные данные | 0..512
`<CR><LF>`| Символы конца сообщения (символы переноса каректи и строки `\r\n`) | Спец. символы ASCII | 2
`'*'` | Символ окончания блока данных. После него в пакет расположены байты контрольной суммы | ASCII-символ | 1
`<CS>` | Байт контрольной суммы пакета | Бинарный | 1


*Примеры пакетов с символьным форматом блока данных*
```
$FORCE$10,-20,30*54\r\n
$MOM$30,40,-50*44\r\n
```

**PT**. Заголовок пакета, содержащий тип пакета `[TYPE]` определяет для взаимодействующих уровней формат, структуру и содержание данных.

**PAYLOAD**. Структура блока данных и содержание данных, а также символ разделителя для символьного формата (рекомендуется символ запятой `,`), определяется пользователем. Обработка, как и генерация блока данных, лежит на пользователе. Обработка данных, соответствущих заголовку, должна происходить в call-back функциях для каждого типа заголовка. Call-back функции вызываются по приему каждого пакета после его анализа встроенным конечным автоматом стека протокола.

