# Протокол взаимодействия уровней системы (верхний, нижний). Описание структуры.

*Данный протокол является развитием протокола взаимодействия верхнего и нижненго уровня подводного аппарата (вспоминай бессоные мартовские ночи 2021 года...).* 

Цель - создать универсальный стек протокола взаимодействия уровней управления внутри одной системы. Обычно различают **верхний (HL)** и **нижний (LL)** уровни системы, между которомы просихордит обмен данными (команды управления, телеметрия и др.). К верхнему уровню может относиться компьютер, встраиваемый микрокомпьютер (одноплатник) или микроконтроллер. К нижнему уровню чаще всего относят микроконтроллер, который отвечает за управление системой на нижнем, аппаратном уровне. Формат обмена данными - текстовый (ASCII симоволы). Все числовые данные переводятся в текстовый формат.

Связь двухсторонняя, асинхронная. Со стороны верхнего уровня (HL) передаются команды управления и запросы (Down Link канал - DL), со стороны нижнего (LL) уровня (Up Link канал - UL) показания датчиков (**телеметрия**) и ответы на запросы.

## Общий формат пакетов

Пакеты сообщение имеют определённую структуру с символами начала, конца сообщения и полями . Данные передаются в символьном виде (ASCII), то есть сообщения представляет собой строку. В пакете могут передаваться сообщения разного характера, который определяется в заголовке пакета - **тип пакета**.

*Примечание.* Версия протокола 2.0 основана на открытых протоколах Wialon IPS и NMEA.

Струкутура пакета:

```
$<TYPE>$<var_1,..,var_n><CR><LF>
|  PT  |     DATA      |
```

**PT** - заголовок пакета

**DATA** - блок данных пакета
Структура блока данных (содержание данных, а также символ разделителя (рекомендуется символ запятой `,`) может определяется пользователем. Обработка, как и генерация блока данных лежит на пользователе. Обработка данных, соответствущих заголовку, происходит в call-back функциях для каждого типа заголовка. 
Ниже приведено детальное описание полей пакета сообщения.

Поле | Описание | Формат
-----|----------|--
`$` | Символ начала пакета (`PRTCL2_START_SYMBOL`). По умолчанию импользуется символ `$`, но может быть переопределён на дургой символ | ASCII-символ
`<TYPE>` | Тип пакета (`PRTCL2_PKG_TYPE`) | ASCII-строка
`$` | Разделитель поля типа пакета и непосредественно содержания сообщения пакета (`PRTCL2_PT_SYMBOL`). Также может быть переропределён другим символом (например, в NMEA это запятая `,`) |
`<var_1,..,var_n>`| Поле сообщения - непосредственно сами данные (сообщение), относящиеся к соответствующему заголовку. Внутри сообщения данные, если их несколько, разделяются знаком запятой `,`. *Данные в некоторых случаях могу отсутствовать, если заголовк считается командой*. | ASCII-строка и бинарные данные. Если бинарные, то разделитель отсутствует
`<CR><LF>`| Символы конца сообщения (символы переноса каректи и строки `\r\n`) | Спец. символы ASCII

```
$FORCE$10,-20,30\r\n
$MOM$30,40,-50\r\n
```

